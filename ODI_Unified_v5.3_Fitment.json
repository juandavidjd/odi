{
  "name": "ODI_Unified_v5.3_Fitment",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "odi-ingest",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook Ingest",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 400],
      "webhookId": "odi-ingest"
    },
    {
      "parameters": {
        "path": "odi-ingest",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "WA Verify",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 200],
      "webhookId": "odi-wa-verify"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.query['hub.verify_token'] }}",
              "value2": "odi_whatsapp_verify_2026"
            }
          ]
        }
      },
      "name": "Token OK",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 200]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query['hub.challenge'] }}",
        "options": {
          "responseCode": 200
        }
      },
      "name": "Challenge OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [650, 120]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "Forbidden",
        "options": {
          "responseCode": 403
        }
      },
      "name": "Forbidden",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [650, 280]
    },
    {
      "parameters": {
        "jsCode": "// ODI NORMALIZER v5.3\nconst input = $json.body || $json;\n\n// WhatsApp\nif (input.entry && input.entry[0]?.changes) {\n  const value = input.entry[0].changes[0]?.value || {};\n  \n  if (!value.messages || !value.messages[0]) {\n    return [{ json: { ignore: true, reason: 'status_update' } }];\n  }\n  \n  const msg = value.messages[0];\n  const contact = value.contacts ? value.contacts[0] : null;\n  \n  let text = '';\n  if (msg.type === 'text') text = msg.text?.body || '';\n  else if (msg.type === 'button') text = msg.button?.text || '';\n  else if (msg.type === 'interactive') text = msg.interactive?.button_reply?.title || '';\n  \n  return [{\n    json: {\n      ignore: false,\n      odi_event_id: 'ODI-' + Date.now().toString(36).toUpperCase(),\n      canal: 'whatsapp',\n      from: msg.from,\n      phone_number_id: value.metadata?.phone_number_id || '',\n      message_id: msg.id,\n      text: text,\n      contact_name: contact?.profile?.name || 'Usuario',\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// API directa\nif (input.text) {\n  return [{\n    json: {\n      ignore: false,\n      odi_event_id: 'ODI-' + Date.now().toString(36).toUpperCase(),\n      canal: input.canal || 'api',\n      from: input.user_id || 'anonymous',\n      text: input.text,\n      contact_name: input.contact_name || 'Usuario',\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nreturn [{ json: { ignore: true, reason: 'unknown' } }];"
      },
      "name": "Normalizer",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.ignore }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Ignorar",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\":\"ignored\"}",
        "options": {
          "responseCode": 200
        }
      },
      "name": "OK Ignored",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [850, 320]
    },
    {
      "parameters": {
        "jsCode": "// INTENT CLASSIFIER v5.3 con extracciÃ³n de entidades\nconst text = ($json.text || '').toLowerCase();\nlet intent = 'GENERAL';\nlet entities = {};\n\n// Extraer marca de moto\nconst marcas = ['yamaha', 'honda', 'suzuki', 'kawasaki', 'bajaj', 'pulsar', 'ktm', 'tvs', 'akt', 'hero', 'auteco', 'victory'];\nfor (const marca of marcas) {\n  if (text.includes(marca)) {\n    entities.marca = marca.toUpperCase();\n    break;\n  }\n}\n\n// Extraer modelo\nconst modelos = ['fz', 'mt', 'r15', 'r3', 'r6', 'nmax', 'bws', 'xtz', 'ybr', 'fazer', 'cb', 'cbr', 'crf', 'xr', 'ninja', 'duke', 'dominar', 'pulsar', 'ns', 'rs', 'discover', 'boxer', 'platino', 'ct100', 'gixxer', 'gsxr', 'vstrom', 'agility', 'twist', 'jet'];\nfor (const modelo of modelos) {\n  if (text.includes(modelo)) {\n    entities.modelo = modelo.toUpperCase();\n    break;\n  }\n}\n\n// Extraer aÃ±o\nconst yearMatch = text.match(/(20[0-2][0-9]|19[89][0-9])/);\nif (yearMatch) {\n  entities.aÃ±o = yearMatch[0];\n}\n\n// Extraer tipo de repuesto\nconst repuestos = ['pastilla', 'freno', 'filtro', 'aceite', 'cadena', 'piÃ±on', 'kit', 'llanta', 'bateria', 'faro', 'direccional', 'espejo', 'manigueta', 'cable', 'clutch', 'embrague', 'suspension', 'amortiguador', 'rodamiento', 'retenedor', 'empaque', 'piston', 'biela', 'cigueÃ±al'];\nfor (const rep of repuestos) {\n  if (text.includes(rep)) {\n    entities.repuesto = rep;\n    break;\n  }\n}\n\n// Clasificar intent\nif (text.match(/^(hola|buenos|buenas|hi|hey)/)) {\n  intent = 'SALUDO';\n} else if (text.includes('sirve') || text.includes('compatible') || text.includes('para que moto') || text.includes('le queda') || text.includes('fitment')) {\n  intent = 'FITMENT';\n} else if ((text.includes('tiene') || text.includes('hay') || text.includes('disponible') || text.includes('stock')) && (entities.repuesto || entities.marca)) {\n  intent = 'FITMENT';\n} else if (text.includes('precio') || text.includes('cuanto') || text.includes('vale') || text.includes('cuesta')) {\n  intent = 'PRECIO';\n} else if (text.includes('comprar') || text.includes('quiero') || text.includes('necesito') || text.includes('llevo')) {\n  intent = 'COMPRA';\n} else if (text.includes('pedido') || text.includes('orden') || text.includes('envio') || text.includes('tracking')) {\n  intent = 'ESTADO_PEDIDO';\n} else if (text.includes('ayuda') || text.includes('problema') || text.includes('soporte') || text.includes('reclamo')) {\n  intent = 'SOPORTE';\n} else if (entities.repuesto || entities.marca || entities.modelo) {\n  // Si menciona repuesto o moto, asumir FITMENT\n  intent = 'FITMENT';\n}\n\nreturn [{ json: { ...$json, intent: intent, entities: entities } }];"
      },
      "name": "Intent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 480]
    },
    {
      "parameters": {
        "jsCode": "// CES EVALUATOR v5.3\nconst intent = $json.intent;\nconst amount = parseFloat($json.amount) || 0;\n\nlet ces = { action: 'PROCEED', risk: 'LOW' };\n\nif (intent === 'COMPRA' && amount > 200000) {\n  ces = { action: 'AWAIT_HUMAN', risk: 'HIGH' };\n}\n\nreturn [{ json: { ...$json, ces: ces } }];"
      },
      "name": "CES",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1050, 480]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.intent }}",
              "value2": "FITMENT"
            }
          ]
        }
      },
      "name": "Es Fitment",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1250, 480]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://odi-m62-fitment:8802/fitment/query",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"q\": \"{{ $json.text }}\"}",
        "options": {
          "timeout": 15000
        }
      },
      "name": "Consultar M6.2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "jsCode": "// FORMATEAR RESPUESTA FITMENT\nconst fitment = $json;\nconst original = $('CES').first().json;\n\nlet responseText = '';\n\nif (fitment.status === 'success' && fitment.results_count > 0) {\n  const main = fitment.main_result;\n  \n  responseText = `âœ… EncontrÃ© ${fitment.results_count} opciones para tu consulta.\\n\\n`;\n  responseText += `ðŸ† *Mejor opciÃ³n:*\\n`;\n  responseText += `${main.title}\\n`;\n  responseText += `ðŸ’° Precio: ${main.price_formatted}\\n`;\n  responseText += `ðŸï¸ Compatible: ${main.compatibility}\\n`;\n  responseText += `ðŸ“¦ Proveedor: ${main.client}\\n\\n`;\n  \n  if (fitment.results_count > 3) {\n    responseText += `ðŸ“‹ Hay ${fitment.results_count - 1} opciones mÃ¡s disponibles.\\n`;\n  }\n  \n  responseText += `Â¿Te interesa esta opciÃ³n o quieres ver mÃ¡s alternativas?`;\n} else {\n  responseText = 'No encontrÃ© resultados exactos para tu consulta. ';\n  responseText += 'Â¿PodrÃ­as darme mÃ¡s detalles como la marca, modelo y aÃ±o de tu moto?';\n}\n\nreturn [{\n  json: {\n    ...original,\n    response_text: responseText,\n    fitment_results: fitment.results || [],\n    fitment_query_id: fitment.query_id || null,\n    fitment_status: fitment.status || 'error'\n  }\n}];"
      },
      "name": "Formatear Fitment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "jsCode": "// RESPUESTA GENERAL (no Fitment)\nconst input = $json;\nconst name = input.contact_name || '';\n\nconst responses = {\n  'SALUDO': `Â¡Hola ${name}! ðŸ‘‹ Soy el asistente de SRM - Somos Repuestos Motos. Â¿En quÃ© puedo ayudarte hoy?`,\n  'PRECIO': 'Para darte el precio exacto, dime quÃ© repuesto necesitas y para quÃ© moto (marca, modelo, aÃ±o).',\n  'COMPRA': 'Perfecto, te ayudo con tu compra. Â¿QuÃ© producto necesitas?',\n  'ESTADO_PEDIDO': 'Para consultar tu pedido, por favor dame el nÃºmero de orden.',\n  'SOPORTE': 'Entiendo que tienes un inconveniente. CuÃ©ntame quÃ© sucediÃ³ y te ayudo a resolverlo.',\n  'GENERAL': 'Gracias por escribir a SRM. Â¿Buscas algÃºn repuesto especÃ­fico? Dime la marca y modelo de tu moto.'\n};\n\nconst text = responses[input.intent] || responses['GENERAL'];\n\nreturn [{ json: { ...input, response_text: text } }];"
      },
      "name": "Response General",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1450, 560]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.canal }}",
              "value2": "whatsapp"
            }
          ]
        }
      },
      "name": "Es WA",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1850, 480]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/987256874463607/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"messaging_product\":\"whatsapp\",\"to\":\"{{ $json.from }}\",\"type\":\"text\",\"text\":{\"body\":\"{{ $json.response_text }}\"}}",
        "options": {}
      },
      "name": "Send WA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\":\"ok\",\"event_id\":\"{{ $json.odi_event_id }}\",\"intent\":\"{{ $json.intent }}\",\"fitment_query_id\":\"{{ $json.fitment_query_id || 'N/A' }}\"}",
        "options": {
          "responseCode": 200
        }
      },
      "name": "OK WA",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2250, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\":\"ok\",\"event_id\":\"{{ $json.odi_event_id }}\",\"intent\":\"{{ $json.intent }}\",\"fitment_query_id\":\"{{ $json.fitment_query_id || 'N/A' }}\",\"response\":\"{{ $json.response_text }}\"}",
        "options": {
          "responseCode": 200
        }
      },
      "name": "OK API",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2050, 560]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO audit_events (event_id, event_type, category, user_id, action_type, target_type, target_id, risk_level, metadata, event_hash) VALUES ($1, 'ACTION_COMPLETED', 'ACTION', $2, 'INGEST', 'message', $3, $4, $5, encode(sha256(($1 || $2 || now()::text)::bytea), 'hex')) RETURNING event_id, sequence_num;",
        "options": {
          "queryReplacement": "={{ [$json.odi_event_id, $json.from, $json.message_id || $json.odi_event_id, $json.ces?.risk?.toLowerCase() || 'low', JSON.stringify({canal: $json.canal, intent: $json.intent, text: $json.text?.substring(0,200), entities: $json.entities, fitment_query_id: $json.fitment_query_id})] }}"
        }
      },
      "name": "Ledger",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2050, 680],
      "credentials": {
        "postgres": {
          "id": "odi-postgres",
          "name": "ODI Postgres"
        }
      }
    }
  ],
  "connections": {
    "Webhook Ingest": {
      "main": [
        [
          {
            "node": "Normalizer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WA Verify": {
      "main": [
        [
          {
            "node": "Token OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Token OK": {
      "main": [
        [
          {
            "node": "Challenge OK",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Forbidden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizer": {
      "main": [
        [
          {
            "node": "Ignorar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ignorar": {
      "main": [
        [
          {
            "node": "OK Ignored",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Intent": {
      "main": [
        [
          {
            "node": "CES",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CES": {
      "main": [
        [
          {
            "node": "Es Fitment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Es Fitment": {
      "main": [
        [
          {
            "node": "Consultar M6.2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response General",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar M6.2": {
      "main": [
        [
          {
            "node": "Formatear Fitment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Fitment": {
      "main": [
        [
          {
            "node": "Es WA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response General": {
      "main": [
        [
          {
            "node": "Es WA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Es WA": {
      "main": [
        [
          {
            "node": "Send WA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OK API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WA": {
      "main": [
        [
          {
            "node": "OK WA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OK API": {
      "main": [
        [
          {
            "node": "Ledger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "active": false
}
